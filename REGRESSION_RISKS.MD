# Analyse des Risques de R√©gression

**Date de l'analyse**: 2026-01-03  
**Version**: v0.1.1  
**Agent**: `/analyze_regression_risks`

---

## üìä R√©sum√© Ex√©cutif

### Couverture de Tests Actuelle

| Type | Nombre | Statut |
|------|--------|--------|
| **Tests E2E** | 20 tests | ‚úÖ Passants |
| **Tests Unitaires** | 0 | ‚ùå Absents |
| **Couverture Pages** | 40% (2/5 pages) | ‚ö†Ô∏è Partiel |

### Zones √† Risque Identifi√©es

| Zone | Risque | Tests E2E | Action |
|------|--------|-----------|--------|
| **ContactsPage** | üî¥ √âlev√© | ‚ùå Manquants | Cr√©er `contacts.spec.ts` |
| **AdminPage** | üî¥ √âlev√© | ‚ùå Manquants | Cr√©er `admin.spec.ts` |
| **TrashPage** | üü° Moyen | ‚ùå Manquants | Cr√©er `trash.spec.ts` |
| **RBAC Logic** | üî¥ Critique | ‚ùå Manquants | Cr√©er `rbac.spec.ts` |
| **Dashboard** | üü¢ Faible | ‚úÖ Couverts | - |
| **Authentication** | üü¢ Faible | ‚úÖ Couverts | - |

---

## üî• Fichiers √† Haut Risque

### Selon l'Historique Git

Fichiers modifi√©s r√©cemment (30 derniers jours) :

1. **`src/pages/AdminPage.tsx`** - Modifi√© pour RBAC
   - ‚ùå Pas de tests E2E d√©di√©s
   - ‚ö†Ô∏è Logique complexe (gestion utilisateurs + filtres)
   - **Action**: Cr√©er `e2e/admin.spec.ts`

2. **`src/pages/ContactsPage.tsx`** - Modifi√© pour RBAC
   - ‚ùå Pas de tests E2E d√©di√©s
   - ‚ö†Ô∏è Permissions conditionnelles
   - **Action**: Cr√©er `e2e/contacts.spec.ts`

3. **`src/hooks/useUserRole.ts`** - Hook RBAC central
   - ‚ùå Pas de tests unitaires
   - üî¥ Critique : utilis√© partout
   - **Action**: Cr√©er tests unitaires + E2E RBAC

4. **`src/lib/supabase.ts`** - Mock localStorage
   - ‚ùå Pas de tests unitaires
   - ‚ö†Ô∏è 665 lignes de code
   - **Action**: Tests unitaires pour les helpers

5. **`src/components/chantiers/CreateContactModal.tsx`**
   - ‚ö†Ô∏è Lint warning (@ts-expect-error)
   - **Action**: Fixer le warning ou justifier

---

## üìù Tests E2E Manquants

### Priorit√© HAUTE üî¥

#### 1. **`e2e/contacts.spec.ts`**

**Sc√©narios critiques** :
```typescript
- Affichage de la liste des contacts
- Recherche et filtres
- Cr√©ation d'un contact (Admin/CA)
- √âdition d'un contact (Admin/CA propri√©taire)
- Suppression d'un contact (Admin/CA propri√©taire)
- V√©rification permissions Poseur (lecture seule)
- V√©rification permissions Superviseur (CRUD complet)
```

#### 2. **`e2e/admin.spec.ts`**

**Sc√©narios critiques** :
```typescript
- Admin : voir tous les utilisateurs
- Admin : cr√©er utilisateur (tous r√¥les)
- Superviseur : voir Poseurs + CA
- Superviseur : cr√©er uniquement Poseur
- Superviseur : modifier uniquement Poseur
- Superviseur : NE PAS voir boutons Edit/Delete pour CA
- Superviseur : NE PAS voir Admin
- CA/Poseur : NE PAS acc√©der √† /admin
```

#### 3. **`e2e/rbac.spec.ts`**

**Sc√©narios critiques** :
```typescript
describe('RBAC - Dashboard Filtering', () => {
  - Admin voit tous les chantiers
  - Superviseur voit tous les chantiers
  - CA voit uniquement ses chantiers assign√©s
  - Poseur voit uniquement ses chantiers assign√©s
});

describe('RBAC - Button Visibility', () => {
  - Poseur ne voit PAS "Nouveau chantier"
  - Poseur ne voit PAS "Modifier" / "Supprimer"
  - CA voit "Nouveau contact"
  - Poseur ne voit PAS "Nouveau contact"
});
```

### Priorit√© MOYENNE üü°

#### 4. **`e2e/trash.spec.ts`**

**Sc√©narios** :
```typescript
- Affichage des √©l√©ments supprim√©s
- Restauration d'un chantier
- Suppression d√©finitive avec confirmation
- Filtrage par type (chantiers/notes/clients)
```

---

## üßπ Am√©lioration des R√®gles Lint

### Warnings Actuels

**√âtat**: 11 warnings, 0 erreur

#### Warnings R√©currents

1. **`react-hooks/exhaustive-deps`** (7 occurrences)
   ```
   Fichiers concern√©s :
   - AddContactModal.tsx
   - CreateChantierModal.tsx
   - NotesSection.tsx
   - PhasesModal.tsx
   - AdminPage.tsx
   - DashboardPage.tsx
   ```
   
   **Impact** : Risque de stale closures ‚Üí bugs subtils
   
   **Action recommand√©e** :
   ```javascript
   // Dans eslint.config.js
   rules: {
     'react-hooks/exhaustive-deps': 'error' // au lieu de 'warn'
   }
   ```

2. **`no-console`** (2 occurrences)
   ```
   Fichiers :
   - src/lib/supabase.ts (ligne 95, 665)
   ```
   
   **Action** : Remplacer par un logger configurable

3. **`@typescript-eslint/no-explicit-any`** (2 occurrences)
   ```
   Fichier : CreateContactModal.tsx (lignes 190, 202)
   ```
   
   **Action** : Typer correctement les √©v√©nements

### R√®gles Lint Recommand√©es

Ajouter dans `eslint.config.js` :

```javascript
export default [
  // ... config existante
  {
    rules: {
      // Forcer la r√©solution des deps useEffect
      'react-hooks/exhaustive-deps': 'error',
      
      // Interdire any (sauf cas justifi√©s avec @ts-expect-error)
      '@typescript-eslint/no-explicit-any': 'error',
      
      // Interdire console.log en production
      'no-console': ['error', { allow: ['warn', 'error', 'info'] }],
      
      // Forcer les PropTypes ou TypeScript
      'react/prop-types': 'off', // On utilise TypeScript
      
      // Interdire les variables non utilis√©es
      '@typescript-eslint/no-unused-vars': ['error', {
        argsIgnorePattern: '^_',
        varsIgnorePattern: '^_'
      }]
    }
  }
];
```

---

## üéØ Plan d'Action Recommand√©

### Phase 1 : Tests E2E Critiques (Priorit√© Imm√©diate)

**Estimation** : 4-6 heures

1. ‚úÖ **Cr√©er `e2e/contacts.spec.ts`**
   - Tester CRUD complet
   - Tester permissions par r√¥le
   - Duration: ~1.5h

2. ‚úÖ **Cr√©er `e2e/admin.spec.ts`**
   - Tester gestion utilisateurs
   - Tester filtres Superviseur
   - Duration: ~2h

3. ‚úÖ **Cr√©er `e2e/rbac.spec.ts`**
   - Tester filtrage Dashboard
   - Tester visibilit√© boutons
   - Duration: ~1.5h

4. ‚úÖ **Cr√©er `e2e/trash.spec.ts`**
   - Tester restauration
   - Tester suppression d√©finitive
   - Duration: ~1h

### Phase 2 : Renforcement Lint (Priorit√© Haute)

**Estimation** : 2-3 heures

1. ‚úÖ **Passer `react-hooks/exhaustive-deps` en erreur**
   - Fixer les 7 warnings existants
   - Duration: ~1.5h

2. ‚úÖ **Fixer `no-console` warnings**
   - Cr√©er un logger helper
   - Remplacer console.log
   - Duration: ~30min

3. ‚úÖ **Fixer `@typescript-eslint/no-explicit-any`**
   - Typer correctement les √©v√©nements
   - Duration: ~30min

### Phase 3 : Tests Unitaires (Priorit√© Moyenne)

**Estimation** : 4-6 heures

1. ‚¨ú **Cr√©er tests unitaires pour `useUserRole`**
   - Tester toutes les combinaisons de r√¥les
   - Duration: ~1.5h

2. ‚¨ú **Cr√©er tests unitaires pour `supabase.ts` helpers**
   - Tester generateUUID, getTable, setTable
   - Duration: ~2h

3. ‚¨ú **Cr√©er tests unitaires pour composants critiques**
   - ChantierCard
   - ConfirmModal
   - Duration: ~2h

---

## üìà M√©triques de R√©gression

### Before vs After

| M√©trique | Avant | Cible | Am√©lioration |
|----------|-------|-------|--------------|
| **Tests E2E** | 20 | 40+ | +100% |
| **Couverture Pages** | 40% | 100% | +60% |
| **Lint Errors** | 0 | 0 | = |
| **Lint Warnings** | 11 | 0 | -100% |
| **Tests Unitaires** | 0 | 15+ | +‚àû |

### Indicateurs de Qualit√©

- **Code Complexity** : Moyenne (acceptable)
- **Technical Debt** : Faible (principalement warnings)
- **Test Coverage** : Partielle (√† am√©liorer)
- **Security** : Bonne (RBAC impl√©ment√©)

---

## üö® Risques R√©siduels

M√™me apr√®s am√©lioration, les risques suivants persisteront :

1. **Pas de tests de performance** ‚Üí Risque de d√©gradation UX
2. **Pas de tests d'accessibilit√©** ‚Üí Risque de non-conformit√©
3. **Pas de tests de s√©curit√©** ‚Üí Risque de failles (injection, XSS)
4. **Pas de tests de compatibilit√© navigateurs** ‚Üí Risque de bugs sp√©cifiques

**Recommandation** : Planifier Phase 4 pour ces aspects.

---

## üìö Ressources

### Outils Recommand√©s

- **Playwright** : E2E tests (d√©j√† install√©)
- **Vitest** : Tests unitaires (√† installer)
- **React Testing Library** : Tests composants (√† installer)
- **Husky** : Pre-commit hooks (optionnel)
- **Lighthouse CI** : Performance tests (optionnel)

### Documentation

- [Playwright Best Practices](https://playwright.dev/docs/best-practices)
- [React Testing Patterns](https://kentcdodds.com/blog/common-mistakes-with-react-testing-library)
- [ESLint React Hooks Rules](https://react.dev/learn/react-compiler#eslint-plugin-react-compiler)

---

**Rapport g√©n√©r√© par `/analyze_regression_risks` workflow**  
*Pour ex√©cuter : `@[/analyze_regression_risks]`*
