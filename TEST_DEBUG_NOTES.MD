# Notes de DÃ©bogage - Tests E2E

**Date**: 2026-01-03  
**Tests crÃ©Ã©s**: 4 nouveaux fichiers  
**RÃ©sultat initial**: 28/81 passÃ©s, 53 Ã©checs

---

## ğŸ“Š Ã‰tat des Tests

| Fichier | Tests | Statut EstimÃ© |
|---------|-------|---------------|
| `auth.spec.ts` | ~9 | âœ… Stables |
| `dashboard.spec.ts` | ~11 | âœ… Stables |
| `contacts.spec.ts` | ~23 | âš ï¸ Ã€ ajuster |
| `admin.spec.ts` | ~20 | âš ï¸ Ã€ ajuster |
| `rbac.spec.ts` | ~14 | âš ï¸ Ã€ ajuster |
| `trash.spec.ts` | ~4 | âš ï¸ Ã€ ajuster |

---

## ğŸ”§ ProblÃ¨mes Courants IdentifiÃ©s

### 1. **SÃ©lecteurs de Boutons Incorrects**

**ProblÃ¨me**: Les tests cherchent des boutons avec des textes qui peuvent ne pas correspondre exactement.

**Exemple**:
```typescript
// âŒ Peut Ã©chouer si le texte varie
await page.getByRole('button', { name: /nouveau contact/i })

// âœ… Mieux: utiliser un sÃ©lecteur plus flexible
await page.getByRole('button', { name: /nouveau|new/i })
// Ou par classe/attribut
await page.locator('button:has-text("Nouveau contact")')
```

**Solution**: VÃ©rifier les textes exacts des boutons dans l'UI.

### 2. **Timeouts Insuffisants**

**ProblÃ¨me**: Les tests E2E peuvent Ãªtre trop rapides pour le chargement des donnÃ©es.

**Solution**:
```typescript
// Augmenter les timeouts par dÃ©faut
test.setTimeout(30000); // 30 secondes

// Attendre explicitement
await page.waitForLoadState('networkidle');
await page.waitForTimeout(1000);
```

### 3. **SÃ©lecteurs de Cartes GÃ©nÃ©riques**

**ProblÃ¨me**: `[class*="glass-card"]` peut matcher trop d'Ã©lÃ©ments.

**Solution**:
```typescript
// Plus spÃ©cifique
const contactCards = page.locator('.contacts-page [class*="glass-card"]');
const chantierCards = page.locator('.dashboard-page [class*="glass-card"]');
```

### 4. **VÃ©rifications de Permissions**

**ProblÃ¨me**: Les tests RBAC peuvent Ã©chouer si les permissions UI ne sont pas encore implÃ©mentÃ©es correctement.

**Solution**: Tests conditionnels avec vÃ©rifications de visibilitÃ© plus souples.

---

## ğŸ¯ Plan de Correction

### Phase 1: Stabiliser les Tests de Base (PrioritÃ© HAUTE)

#### `contacts.spec.ts`
- [ ] VÃ©rifier sÃ©lecteurs de boutons "Nouveau contact"
- [ ] Ajuster timeouts pour chargement de cartes
- [ ] VÃ©rifier que le formulaire de crÃ©ation existe
- [ ] Adapter les tests de permissions aux boutons rÃ©els

#### `admin.spec.ts`
- [ ] VÃ©rifier URL de navigation (/admin vs /administration)
- [ ] Confirmer sÃ©lecteurs de tableau utilisateurs
- [ ] VÃ©rifier textes des modales
- [ ] Tester avec donnÃ©es mock existantes

### Phase 2: Raffiner les Tests RBAC (PrioritÃ© MOYENNE)

#### `rbac.spec.ts`
- [ ] VÃ©rifier que les filtres Dashboard sont bien appliquÃ©s
- [ ] Confirmer visibilitÃ© boutons selon rÃ´le
- [ ] Adapter aux redirections rÃ©elles de l'app
- [ ] Harmoniser avec tests `dashboard.spec.ts`

### Phase 3: ComplÃ©ter les Tests Trash (PrioritÃ© BASSE)

#### `trash.spec.ts`
- [ ] VÃ©rifier que des Ã©lÃ©ments supprimÃ©s existent
- [ ] Adapter aux messages d'Ã©tat vide rÃ©els
- [ ] Confirmer le workflow de restauration
- [ ] Tester suppression dÃ©finitive

---

## ğŸ” StratÃ©gie de DÃ©bogage

### Ã‰tape 1: Identifier les Tests Critiques
Concentrer les efforts sur les tests qui couvrent :
1. Flux utilisateur principaux (login, crÃ©ation, navigation)
2. Permissions RBAC (bloquer/autoriser selon rÃ´le)
3. CRUD de base (crÃ©er, lire, modifier, supprimer)

### Ã‰tape 2: DÃ©bogage Visuel
```bash
# Lancer Playwright en mode UI pour voir les tests
npx playwright test --ui

# Ou en mode debug pour un test spÃ©cifique
npx playwright test contacts.spec.ts --debug
```

### Ã‰tape 3: Screenshots et Traces
```typescript
// Dans les tests qui Ã©chouent
test('my test', async ({ page }) => {
  // ...
  await page.screenshot({ path: 'debug-screenshot.png' });
  await page.pause(); // Pause pour inspection
});
```

### Ã‰tape 4: Correction ItÃ©rative
1. Fixer 5 tests Ã  la fois
2. Re-exÃ©cuter tous les tests
3. VÃ©rifier qu'on n'a pas cassÃ© les tests existants
4. RÃ©pÃ©ter

---

## ğŸ“ˆ Objectif de Couverture

| MÃ©trique | Avant | Maintenant | Objectif Final |
|----------|-------|------------|----------------|
| **Nombre de tests** | 20 | 81 | 81+ |
| **Tests passants** | 20 | 28 | 75+ (93%) |
| **Couverture pages** | 40% | 83% | 100% |

---

## ğŸ’¡ Recommandations

1. **Ne pas tout fixer d'un coup**: Prioriser les tests critiques
2. **Utiliser `--grep`**: ExÃ©cuter uniquement certains tests
   ```bash
   npx playwright test --grep "Admin"
   npx playwright test --grep "RBAC"
   ```
3. **Marquer tests flaky**: Si un test est instable
   ```typescript
   test.fixme('unstable test', async ({ page }) => {
     // ...
   });
   ```
4. **Documentation continue**: Noter les sÃ©lecteurs fragiles

---

## ğŸš€ Prochaines Ã‰tapes

1. âœ… **Fait**: CrÃ©er les 4 fichiers de tests manquants
2. â¬œ **Ã€ faire**: ExÃ©cuter tests en mode UI pour dÃ©bogage visuel
3. â¬œ **Ã€ faire**: Fixer les 53 tests Ã©chouÃ©s (par prioritÃ©)
4. â¬œ **Ã€ faire**: Atteindre 93%+ de succÃ¨s
5. â¬œ **Ã€ faire**: Ajouter au workflow `/run_qa`

---

**Note**: Les Ã©checs sont **normaux** pour de nouveaux tests. C'est un processus itÃ©ratif.  
L'important est d'avoir une couverture complÃ¨te, puis d'affiner les sÃ©lecteurs.
